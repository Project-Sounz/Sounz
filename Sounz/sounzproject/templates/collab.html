{% extends 'base.html' %}
{% load static %}
{% block title %}Sounz{% endblock %}
{% block additional_css %}
<link rel="stylesheet" href="{% static 'css/collab-workspace.css' %}">
<style>
#chatContainer {
    width: 50%;
    height: 100vh;
    border: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    margin: auto;
    padding: 10px;
    overflow: hidden;
}

#chatMessages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    border-bottom: 1px solid #ccc;
}

#messageInput {
    width: calc(100% - 20px);
    padding: 5px;
    border: 1px solid #ccc;
}

button {
    padding: 5px 10px;
    border: none;
    background: #444;
    color: white;
    cursor: pointer;
}

button:hover {
    background: #666;
}

.message {
    padding: 5px;
    margin: 5px 0;
    border-bottom: 1px solid #ddd;
}

</style>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadChatHistory(); // Load messages on page load
        setInterval(loadChatHistory, 1000); // Refresh messages every second
    });

    function loadChatHistory() {
        fetch("{% url 'get_chat_history' collab_id=collab_id %}")
            .then(response => response.json())
            .then(data => {
                let chatBox = document.getElementById("chatMessages");
                chatBox.innerHTML = ""; // Clear previous messages

                data.chat_history.forEach(chat => {
                    let newMessage = document.createElement("div");
                    let isUser = chat.username === "{{ request.user.username }}";

                    newMessage.className = isUser ? "message user" : "message other";
                    newMessage.innerHTML = `
                        <strong>${chat.username}:</strong> ${chat.message}
                    `;

                    chatBox.appendChild(newMessage);
                });

                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
            })
            .catch(error => console.error("Error fetching chat history:", error));
    }

    function sendMessage() {
        let messageInput = document.getElementById("messageInput");
        let messageText = messageInput.value.trim();
        if (messageText === "") return;

        fetch("{% url 'send_chat_message' collab_id=collab_id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(),
            },
            body: JSON.stringify({ message: messageText }),
        })
        .then(() => {
            loadChatHistory(); // Reload messages after sending
        })
        .catch(error => console.error("Error sending message:", error));

        messageInput.value = "";
    }

    function getCSRFToken() {
        return document.cookie.split("; ").find(row => row.startsWith("csrftoken="))?.split("=")[1];
    }
</script>




{% endblock %}
{% block content %}
<!-- <div class="header-for-home">{% include 'header-base-sub.html' %}</div> -->
<input type="hidden" id="collabId" value="{{ collab.collaboration_Id }}">
<input type="hidden" id="userId" value="{{ user_id }}">
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<div class="main-collab-container">
    <div class="header-button">
        <button id="refresh">Refresh</button>
    </div>
    <div class="collab-and-chat">
        <div class="collab-tool">
            <div class="audio-lists">
                <div class="base-audio-container">
                    <div class="base-audio-graph b-s-Allaudio" id="base-audio-graph"><input type="hidden" id="base-audio-storage" value="{{ post_base.media.url }}"></div>
                    <div class="base-audio-controls">
                        <div class="base-audio-contents">
                            <p id="base-contents"><span id="audio-title">{{ post_base.caption }}</span><span id="divider">â€¢</span><span id="main-show-button">Main Audio</span></p>
                        </div>
                        <div id="base-audio-control-panel">
                            <div class="control-base">
                                <img class="single-audio-play" src="{% static 'images/audio-play.svg' %}" data-container="base-audio-graph" alt="play-button">
                                <img class="single-audio-pause" src="{% static 'images/audio-pause.svg' %}" data-container="base-audio-graph" alt="pause-button">
                                <img class="single-audio-stop" src="{% static 'images/audio-stop.svg' %}" data-container="base-audio-graph" alt="stop-button">    
                            </div>
                            <div class="volume-base">
                                <label for="base-volume"><img class="single-volume-icon" src="{% static 'images/audio-volume.svg' %}" alt="volume-button"></label>
                                <input class="single-volume" data-container="base-audio-graph" type="range" id="base-volume" min="0" max="1" step="0.01" value="1">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="main-sync-container">
                    
                </div>
            </div>
            <div class="g-rSync-container" id="g-rSync-container" style="display: none;">
                <div class="g-rSync-audio-graph b-s-Allaudio" id="g-rSync-audio-graph"></div>
                <div class="sync-audio-controls">
                    <div class="g-rSync-buttons">
                        <button id="g-rSync-sync">Sync</button>
                        <button id="g-rSync-redo">Redo</button>
                    </div>
                    <div id="g-rSync-control-panel">
                        <div class="control-rSync">
                            <img class="single-audio-play" src="{% static 'images/audio-play.svg' %}" data-container="g-rSync-audio-graph" alt="play-button">
                            <img class="single-audio-pause" src="{% static 'images/audio-pause.svg' %}" data-container="g-rSync-audio-graph" alt="pause-button">
                            <img class="single-audio-stop" src="{% static 'images/audio-stop.svg' %}" data-container="g-rSync-audio-graph" alt="stop-button">    
                        </div>
                        <div class="volume-sync">
                            <label for="volume"><img class="single-volume-icon" src="{% static 'images/audio-volume.svg' %}"  alt="volume-button"></label>
                            <input type="range" data-container="g-rSync-audio-graph" class="single-volume" id="g-rSy-volume" min="0" max="1" step="0.01" value="1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="master-control-container">
                <div class="master-controls">
                    <!-- <label>Mic Volume:</label>
                    <input type="range" class="mic-volume" id="mic-volume" min="0" max="1" step="0.01" value="1"> -->
                
                    <button id="masterPlayRecord">Record & Play</button>
                    <button id="pauseRecording" disabled>Pause Recording</button>
                    <button id="masterStopRecord">Stop Record</button>
                    <button id="masterPlay">Play</button>
                    <button id="masterPause">Pause</button>
                    <button id="masterStop">Stop</button>
                
                    <label>Master Speaker Volume:</label>
                    <input type="range" class="master-volume" id="master-volume" min="0" max="1" step="0.01" value="1">
                
                    <label id="uploadLabel" for="audioUpload">Choose File</label>
                    <input type="file" id="audioUpload" accept="audio/*" hidden>
                </div>
            </div>
        </div>
        <div id="chatContainer">
            <div id="chatMessages">
                {% for chat in chat_history %}
                    <div class="message {% if chat.username == request.user.username %}user{% else %}other{% endif %}">
                        <strong>{{ chat.username }}:</strong> {{ chat.message }}
                    </div>
                {% endfor %}
            </div>
            <input type="text" id="messageInput" placeholder="Type a message..." />
            <button onclick="sendMessage()">Send</button>
        </div>
        
        
        
        
            
            
       
    </div>
    <div class="footer-control">
        <div class="button_ofAcceptance">
            <button id="approval-button" onclick="approveButton(this,'approve')">Approve</button>
            <p id="approval-status"><span id="accept-count">{{collab.accept_count}}</span> / {{collab.owner_count}} Approved</p>
            <button id="upload-warning-button" style="display: none;">Mix and Upload</button>
        </div>
    </div>
</div>
<script src="https://unpkg.com/wavesurfer.js"></script>
<script src="{% static 'js/collab-tool.js' %}"></script>
<script src="{% static 'js/audio-mixing.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.0/lame.min.js"></script>
{% endblock %}